<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>تزریق! نسخه به باینری وقت کامپایل #Golang &middot; </title>

  
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/poole.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/hyde.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/poole-overrides.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/hyde-x.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://fzero.rubi.gd/css/hacks.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://fzero.rubi.gd/touch-icon-144-precomposed.png">
  <link href="http://fzero.rubi.gd/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="برای این قسمت تصمیم گرفتم اسم سرخ پوستی بذارم، یه چیزی تو مایه های لطفا بمیر پلن ناین لعنتی!">
  <meta name="keywords" content="go">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-76159433-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1></h1>
      <p class="lead">یک وبلاگ دیگر از یک برنامه نویس دیگر</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://fzero.rubi.gd/">وبلاگ</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/fzerorubigd"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      
      <a href="https://twitter.com/fzerorubigd"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="http://fzero.rubi.gd/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

    <p>Copyright &copy; 2021 <a href="http://fzero.rubi.gd/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">تزریق! نسخه به باینری وقت کامپایل #Golang</h1>
    <span class="post-date">May 1, 2016 &middot; 3 minute read &middot; <a href="http://fzero.rubi.gd/post/go/inject-go-version/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="http://fzero.rubi.gd/categories/go">go</a><a class="label" href="http://fzero.rubi.gd/categories/trick">trick</a>
    </span>
    <p>بدنیست همیشه یه اطلاعاتی از نسخه برنامه تو دل خودش باشه. مدتهاست که من از Make برای کامپایل برنامه استفاده میکنم، و قبلترها، قبل از اینکه کامپایل کنم برنامه رو، یک فایل میساختم (به صورت اتوماتیک) مثلا با این محتوا :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span> 
<span style="color:#75715e">// this file is autogenerated
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> (
	<span style="color:#75715e">// Commit hash 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hash</span>  = <span style="color:#e6db74">&#34;a5df371b88bc3f875f49a3b7e19b55c88cd31487&#34;</span>
	<span style="color:#a6e22e">short</span> = <span style="color:#e6db74">&#34;a5df371&#34;</span>
	<span style="color:#75715e">// commit date
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">date</span>  = <span style="color:#e6db74">&#34;2016-04-30 11:21:46 +0430 +0430&#34;</span>
	<span style="color:#75715e">// build date 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">build</span> = <span style="color:#e6db74">&#34;2016-04-30 11:21:46 +0430 +0430&#34;</span>
	<span style="color:#75715e">// commit count
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">count</span> = <span style="color:#e6db74">&#34;42&#34;</span>
)
</code></pre></div><p>بعد قبل هر کامپایل این فایل مجددا ساخته میشه و متغیرهاش آپدیت میشن. خوبه، ولی نه به اندازه کافی. این فایل باید ignore بشه تو ورژن کنترل، کسی از کامند مناسب استفاده نکنه ساخته نمیشه و الی آخر. این شد که افتادم دنبال راه حل بهتر.</p>
<p>بعد از اینکه کامپایلر کارش تموم میشه، و فایل های میانی ساخته میشن، لینکر اونها رو به هم لینک میکنه و فایل نهایی ساخته میشن. تو این مرحله، تازه رفرنسها مشخص میشن، و ارتباطها پیدا میشن و در صورتی که ارتباطی پیدا نشه خطا گرفته میشه، البته برای گو، یه لول هم قبلتر اتفاق میفته، (بر خلاف سی) ولی خوب، کلا قضیه اینه که اگه بخوای یه متغییر رو عوض کنی، بعد از کامپایل میشه.</p>
<p>برای اینکار گو سوییچ ‍<code>-X</code> رو معرفی کرده. خیلی ساده، <code>-ldflags &quot;-X pkg.variable=value‍</code> اینجوری میتونم به لینکر بگم که متغییری به اسم <code>variable</code> توی پکیجی به اسم <code>pkg</code> باید مقدارش برابر باشه با <code>value</code> . با این روش فقط میشه متغییر های رشته ای (string) رو وارد برنامه کرد و تایپ نمیشناسه.</p>
<p>مثلا این برنامه رو در نظر بگیرید :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">variable</span> <span style="color:#66d9ef">string</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">variable</span>)
}
</code></pre></div><p>کامپایلش کنید طبیعیه که خروجی یه خط خالیه. ولی حالا اینجوری کامپایلش کنید :</p>
<pre tabindex="0"><code>go build -ldflags &quot;-X main.variable=value&quot;
</code></pre><p>و دیگه خروجی خالی نیست. اگه از <a href="https://getgb.io/">gb</a> استفاده میکنید (من استفاده میکنم :) ) اونهم این فلگ رو میشناسه. مثلا من این خطوط رو اول Makefile گذاشتم :</p>
<pre tabindex="0"><code>export LONGHASH=$(shell git log -n1 --pretty=&quot;format:%H&quot; | cat)
export SHORTHASH=$(shell git log -n1 --pretty=&quot;format:%h&quot;| cat)
export COMMITDATE=$(shell git log -n1 --pretty=&quot;format:%cd&quot;| sed -e &quot;s/ /-/g&quot;)
export COMMITCOUNT=$(shell git rev-list HEAD --count| cat)
export BUILDDATE=$(shell date| sed -e &quot;s/ /-/g&quot;)
export FLAGS=&quot;-X shared/config.hash=$(LONGHASH) -X shared/config.short=$(SHORTHASH) -X shared/config.date=$(COMMITDATE) -X shared/config.count=$(COMMITCOUNT) -X shared/config.build=$(BUILDDATE)&quot;
export LDARG=-ldflags $(FLAGS)
</code></pre><p>و هر وقت تو Makefile بخوام چیزی رو کامپایل کنم اینجوری میشه :</p>
<pre tabindex="0"><code>$(BIN)/gb build $(LDARG)
</code></pre><p>تو پکیج <code>shared/config</code> هم چنین چیزی دارم :</p>
<pre tabindex="0"><code>// The following variables are injected at compile time, do not edit
var (
	hash  string
	short string
	date  string
	build string
	count string
)

func init() {
	Config.Count, _ = strconv.ParseInt(count, 10, 64)
	Config.Date, _ = time.Parse(&quot;Mon-Jan-02-15:04:05-2006--0700&quot;, date)
	Config.Hash = hash
	Config.Short = short
	Config.BuildDate, _ = time.Parse(&quot;Mon-Jan-02-15:04:05-MST-2006&quot;, build)

}

</code></pre><p>&ndash; متوجه شدید این حضرات مکافات، تو کامپایلر go به جای دو تا دش از یه دش استفاده میکنن؟ این یکی از مشکلاتیه که من باهاشون دارم! لامصبا رفتن استاندارد مزخرف <a href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">plan9</a> رو اینجا استفاده کردن به جای <a href="https://en.wikipedia.org/wiki/Getopt">getopt</a> :/</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "fzerorubigd";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "fzerorubigd";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="http://fzero.rubi.gd/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

